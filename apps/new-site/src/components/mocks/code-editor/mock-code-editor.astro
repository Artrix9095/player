---
import clsx from 'clsx';

import CodeSnippet from '../../code-snippet/code-snippet.astro';
import MockWindowBar from '../mock-window-bar.svelte';
import {
  buildTreeItems,
  findActiveFile,
  genCodeEditorId,
  getFileId,
  isCodeFile,
  isImageFile,
  type EditorFile,
} from './code-editor';
import CodeEditorPanes from './code-editor-panes.svelte';
import FileExplorerSidebar from './file-explorer-sidebar.svelte';
import FileExplorerTreeItems from './file-explorer-tree-items.astro';
import FileExplorerTree from './file-explorer-tree.svelte';

interface Props {
  files: EditorFile[];
  openFile: string;
  nextTemplate?: boolean;
}

const { files, openFile, nextTemplate = false } = Astro.props;

const id = genCodeEditorId(),
  editorId = `mock-code-editor-${id}`,
  defaultFile = findActiveFile(files, openFile);

if (nextTemplate) {
  files.push(
    { path: 'next.config.ts', snippet: `templates/next.config` },
    { path: 'package.json', snippet: `templates/package` },
    { path: 'tailwind.config.cjs', snippet: `templates/tailwind.config` },
  );
}
---

<section
  id={editorId}
  class={clsx(
    'w-full border border-border flex flex-col flex-1 max-w-[1280px] mx-auto h-[600px] 1200:h-[680px]',
    'rounded-md shadow-md 1200:shadow-lg bg-elevate @container overflow-hidden',
  )}
  aria-label="Mock Code Editor"
  style="--code-block-max-h: 522px;"
>
  <MockWindowBar />

  <div class="w-full flex-1 flex flex-row relative">
    <FileExplorerSidebar client:visible>
      <aside>
        <FileExplorerTree client:visible>
          <FileExplorerTreeItems {id} items={buildTreeItems(files, defaultFile)} depth={0} />
        </FileExplorerTree>
      </aside>
    </FileExplorerSidebar>

    <CodeEditorPanes client:visible>
      <Fragment slot="editor">
        {
          files.map((file, i) =>
            isCodeFile(file) ? (
              <CodeSnippet
                id={file.snippet}
                domId={getFileId(id, i)}
                flat
                numbered
                style={file !== defaultFile ? 'display: none;' : null}
              />
            ) : (
              <div
                id={getFileId(id, i)}
                class="w-full h-full flex items-center justify-center"
                style="display: none;"
              >
                <div class="rounded-md overflow-hidden shadow-md max-w-lg aspect-video w-full border border-border">
                  {isImageFile(file) ? (
                    <img
                      class={clsx('w-full object-fill', file.class)}
                      src={file.imgSrc}
                      alt={file.imgAlt}
                      decoding="async"
                    />
                  ) : (
                    <video
                      class="w-full aspect-video"
                      src={file.videoSrc}
                      controls
                      playsinline
                      muted
                    />
                  )}
                </div>
              </div>
            ),
          )
        }
      </Fragment>

      <slot name="preview" slot="preview" />
    </CodeEditorPanes>
  </div>
</section>
