---
import clsx from 'clsx';
import CodeHighlightLines from './code-highlight-lines.astro';
import HMRCodeHighlightLines from './hmr/code-highlight-lines.svelte';
import HMRLineNumbers from './hmr/code-line-numbers.svelte';

interface Props {
  id: string;
  flat?: boolean;
  numbered?: boolean;
  lines: number;
  highlights?: string;
}

const { id, lines, highlights, numbered, flat } = Astro.props;

const lineNumbers = [...Array(lines).keys()].map((n) => n + 1),
  lineNumberProps = {
    class: clsx(
      '992:flex absolute top-0 left-0 m-0 hidden flex-col text-sm leading-[var(--leading)]',
      'flex-none select-none text-right text-soft/40',
      highlights ? 'pl-2' : 'pl-0',
    ),
    style: 'border-radius: 0; padding-top: 0;',
    'aria-hidden': 'true',
    'data-numbers': true,
  } as const;
---

<div
  class={clsx(
    'code-block relative text-sm leading-[var(--leading)]',
    !flat
      ? 'shadow-xl rounded-md border-border border 576:max-h-[32rem] max-h-[60vh] scrollbar scroll-contain mx-auto overflow-y-auto'
      : 'w-full h-full',
  )}
  style="--leading: 1.375rem;"
  data-numbers={!!numbered}
  data-hl={!!highlights}
>
  <slot name="top" />

  <div class="relative z-0 overflow-hidden">
    <slot />

    {
      numbered && import.meta.env.DEV ? (
        <HMRLineNumbers
          {id}
          {lines}
          {...lineNumberProps}
          class={lineNumberProps.class}
          client:visible
        />
      ) : (
        <pre {...lineNumberProps} set:html={lineNumbers.join('\n')} />
      )
    }

    {
      import.meta.env.DEV ? (
        <HMRCodeHighlightLines {id} {lines} {highlights} client:visible />
      ) : (
        <CodeHighlightLines {lines} {highlights} />
      )
    }
  </div>
</div>

<style>
  .code-block :global(pre code[data-lang-bash] span) {
    color: #fafafa !important;
  }

  .code-block :global(pre code[data-lang-bash] .line:not(:empty)::before) {
    content: '> ';
    font-weight: bold;
    color: var(--terminal-line-pointer);
  }

  .code-block[data-numbers] :global(pre:not([data-numbers])) {
    display: inline-flex;
    tab-size: 2;
    -o-tab-size: 2;
    -moz-tab-size: 2;
    padding-left: 2.5rem;
  }

  .code-block :global(code) {
    display: block;
  }
</style>
